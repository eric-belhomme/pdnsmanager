{% extends "base.html" %}

{% block scripts %}
<script>
    function sortTable(tableId, n, type) {
        var table = document.getElementById(tableId);
        var tbody = table.querySelector("tbody");
        var rows = Array.from(tbody.rows);
        var dir = table.getAttribute("data-sort-dir") === "asc" ? "desc" : "asc";
        
        // Reset icons in this table
        table.querySelectorAll("th i").forEach(icon => {
            icon.className = "sort-icon fa-solid fa-sort text-gray-400 ml-1";
        });
        
        rows.sort(function(a, b) {
            var x = a.cells[n].innerText.trim().toLowerCase();
            var y = b.cells[n].innerText.trim().toLowerCase();
            
            if (tableId === 'reverse-zones-table' && n === 0) {
                var getParts = function(str) {
                    if (str.indexOf('.in-addr.arpa') !== -1) {
                        var parts = str.split('.in-addr.arpa')[0].split('.');
                        return parts.reverse().map(function(p) { return parseInt(p, 10) || 0; });
                    }
                    return [str];
                };
                var xParts = getParts(x);
                var yParts = getParts(y);
                
                if (Array.isArray(xParts) && Array.isArray(yParts) && typeof xParts[0] === 'number') {
                    for (var i = 0; i < Math.max(xParts.length, yParts.length); i++) {
                        if ((xParts[i] || 0) < (yParts[i] || 0)) return dir === "asc" ? -1 : 1;
                        if ((xParts[i] || 0) > (yParts[i] || 0)) return dir === "asc" ? 1 : -1;
                    }
                    return 0;
                }
            }

            if (type === 'number') { x = parseFloat(x) || 0; y = parseFloat(y) || 0; }
            if (x < y) return dir === "asc" ? -1 : 1;
            if (x > y) return dir === "asc" ? 1 : -1;
            return 0;
        });
        
        rows.forEach(row => tbody.appendChild(row));
        
        table.setAttribute("data-sort-dir", dir);
        var headerIcon = table.querySelectorAll("th")[n].querySelector("i");
        headerIcon.className = dir === "asc" ? "sort-icon fa-solid fa-sort-up text-indigo-600 ml-1" : "sort-icon fa-solid fa-sort-down text-indigo-600 ml-1";
    }

    function setDNSServer(tid) {
            document.cookie = `pdns_client_id=${tid}; path=/; max-age=31536000`;
            window.location.reload();
    }
</script>
{% endblock %}

{% block header_left %}
<h1 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mr-4">
    <i class="fa-solid fa-network-wired mr-2"></i> PDNS Manager
</h1>

<!-- pDNS Server Selector -->
<select onchange="setDNSServer(this.value)" class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-200 py-1 px-2 rounded text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
{% for server in pdns_servers %}
    <option value="{{ server.tid }}" {% if server.tid == pdns_client.tif %}selected{% endif %}>{% if server.status %}ðŸŸ¢ {% else %}ðŸ”´ {% endif %}{{ server.nickname }}</option>
{% endfor %}
</select>

{% if not pdns_client.status %}
  <span class="group relative inline-block cursor-help bg-red-100 text-red-800 text-xs font-semibold px-2.5 py-0.5 rounded dark:bg-red-900 dark:text-red-200">
    {{ _('api_disconnected') }}
{% else %}
  <span class="group relative inline-block cursor-help bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-0.5 rounded dark:bg-green-900 dark:text-green-200">
    {{ _('api_connected') }}
{% endif %}

    <div class="invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-all duration-200 absolute z-[9999] top-full left-0 mt-2 w-72 p-3 bg-slate-900 text-white text-[11px] rounded-md shadow-2xl pointer-events-none ring-1 ring-white/10">
      
      <div class="flex items-center justify-between border-b border-slate-700 mb-2 pb-1">
        <span class="font-bold text-indigo-400 uppercase">DÃ©tails de l'API</span>
        <span class="text-[9px] px-1 bg-slate-800 rounded text-slate-400 uppercase">{{ pdns_client.daemon_type }}</span>
      </div>
      
      <div class="grid grid-cols-1 gap-1">
        <p><span class="text-slate-400">Nom:</span> {{ pdns_client.nickname }}</p>
        <p><span class="text-slate-400">ID:</span> {{ pdns_client.server_id }}</p>
        <p class="break-all"><span class="text-slate-400">API URL:</span> <span class="text-blue-300">{{ pdns_client.base_url }}</span></p>
        <p><span class="text-slate-400">Version:</span> {{ pdns_client.version }}</p>
        
        <div class="mt-2 pt-2 border-t border-slate-800 space-y-1">
          <p class="break-all italic text-slate-400">Config: {{ pdns_client.config_url }}</p>
          <p class="break-all italic text-slate-400">Zones: {{ pdns_client.zones_url }}</p>
        </div>
      </div>
    </div>
  </span>

{% endblock %}

{% block content %}

        <!-- Zone d'erreur -->
        {% if not pdns_client.status %}
        <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6" role="alert">
            <span class="bg-red-100 text-red-800 text-xs font-semibold px-2.5 py-0.5 rounded dark:bg-red-900 dark:text-red-200">{{ _('api_disconnected') }}</span>
        </div>
        {% else %}

        <!-- Formulaire d'ajout -->
        <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100">{{ _('add_zone') }}</h2>
            <form action="/zones/add" method="post" class="flex gap-4 items-end">
                <div class="flex-1">
                    <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="domain">
                        {{ _('domain') }}
                    </label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 dark:border-gray-600 leading-tight focus:outline-none focus:shadow-outline disabled:opacity-50 disabled:cursor-not-allowed" 
                           id="domain" name="domain" type="text" placeholder="example.com" {% if error %}disabled{% endif %}>
                </div>
                <div class="w-1/4">
                    <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="kind">
                        {{ _('type') }}
                    </label>
                    <select class="shadow border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 dark:border-gray-600 leading-tight focus:outline-none focus:shadow-outline disabled:opacity-50 disabled:cursor-not-allowed" 
                            id="kind" name="kind" {% if error %}disabled{% endif %}>
                        <option value="Native">{{ _('native') }}</option>
                        <option value="Master">{{ _('master') }}</option>
                        <option value="Slave">{{ _('slave') }}</option>
                    </select>
                </div>
                <button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline disabled:opacity-50 disabled:cursor-not-allowed" type="submit" {% if error %}disabled{% endif %}>
                    <i class="fa-solid fa-plus"></i> {{ _('create') }}
                </button>
            </form>
        </div>

        <!-- Zones Directes -->
        <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300">{{ _('forward_zones') }}</h2>
        <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg overflow-hidden mb-8">
            <table id="forward-zones-table" class="min-w-full leading-normal">
                <thead>
                    <tr>
                        <th class="px-5 py-3 border-b-2 border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider cursor-pointer select-none" onclick="sortTable('forward-zones-table', 0, 'text')">
                            <div class="flex items-center">
                                {{ _('zone_domain') }} <i class="sort-icon fa-solid fa-sort text-gray-400 ml-1"></i>
                            </div>
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                            {{ _('type') }}
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                            {{ _('serial') }}
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 text-right text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                            {{ _('actions') }}
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for zone in forward_zones %}
                    <tr>
                        <td class="px-5 py-5 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm">
                            <div class="flex items-center">
                                <div class="ml-3">
                                    {% if zone.role != 'none' %}
                                    <a href="/zones/{{ zone.id }}" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-900 dark:hover:text-indigo-300 font-medium hover:underline">
                                        {{ zone.name }}
                                    </a>
                                    {% else %}
                                    <span class="text-gray-400 dark:text-gray-500 cursor-not-allowed" title="{{ _('access_denied') }}">
                                        {{ zone.name }} <i class="fa-solid fa-lock text-xs ml-1"></i>
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm">
                            <span class="relative inline-block px-3 py-1 font-semibold text-green-900 leading-tight">
                                <span aria-hidden class="absolute inset-0 bg-green-200 opacity-50 rounded-full"></span>
                                <span class="relative">{{ zone.kind }}</span>
                            </span>
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm">
                            <p class="text-gray-900 dark:text-gray-300 whitespace-no-wrap">{{ zone.serial }}</p>
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm text-right">
                            {% if zone.role == 'owner' %}
                            <form action="/zones/delete/{{ zone.id }}" method="post" onsubmit="return confirm('{{ _('confirm_zone_del') }}');">
                                <button type="submit" class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300">
                                    <i class="fa-solid fa-trash"></i> {{ _('delete') }}
                                </button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="px-5 py-5 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm text-center text-gray-500 dark:text-gray-400">
                            {{ _('no_forward') }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Zones Inverses -->
        <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300">{{ _('reverse_zones') }}</h2>
        <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg overflow-hidden">
            <table id="reverse-zones-table" class="min-w-full leading-normal">
                <thead>
                    <tr>
                        <th class="px-5 py-3 border-b-2 border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider cursor-pointer select-none" onclick="sortTable('reverse-zones-table', 0, 'text')">
                            <div class="flex items-center">
                                {{ _('zone_domain') }} <i class="sort-icon fa-solid fa-sort text-gray-400 ml-1"></i>
                            </div>
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                            {{ _('type') }}
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                            {{ _('serial') }}
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 text-right text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                            {{ _('actions') }}
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for zone in reverse_zones %}
                    <tr>
                        <td class="px-5 py-5 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm">
                            <div class="flex items-center">
                                <div class="ml-3">
                                    {% if zone.role != 'none' %}
                                    <a href="/zones/{{ zone.id }}" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-900 dark:hover:text-indigo-300 font-medium hover:underline">
                                        {{ zone.name }}
                                    </a>
                                    {% else %}
                                    <span class="text-gray-400 dark:text-gray-500 cursor-not-allowed" title="{{ _('access_denied') }}">
                                        {{ zone.name }} <i class="fa-solid fa-lock text-xs ml-1"></i>
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm">
                            <span class="relative inline-block px-3 py-1 font-semibold text-green-900 leading-tight">
                                <span aria-hidden class="absolute inset-0 bg-green-200 opacity-50 rounded-full"></span>
                                <span class="relative">{{ zone.kind }}</span>
                            </span>
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm">
                            <p class="text-gray-900 dark:text-gray-300 whitespace-no-wrap">{{ zone.serial }}</p>
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm text-right">
                            {% if zone.role == 'owner' %}
                            <form action="/zones/delete/{{ zone.id }}" method="post" onsubmit="return confirm('{{ _('confirm_zone_del') }}');">
                                <button type="submit" class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300">
                                    <i class="fa-solid fa-trash"></i> {{ _('delete') }}
                                </button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="px-5 py-5 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm text-center text-gray-500 dark:text-gray-400">
                            {{ _('no_reverse') }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

{% endblock %}
